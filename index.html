<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maze CAPTCHA</title>
  <style>
    canvas {
      border: 1px solid black;
      display: block;
      margin: 0 auto;
    }
    #timer {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
    }
    button {
      border: 1px solid #333;
      border-radius: 5px;
      background-color: #f0f0f0;
      cursor: pointer;
    }
    button:hover {
      background-color: #ddd;
    }
  </style>
</head>
<body>
  <canvas id="mazeCanvas" width="300" height="300"></canvas>
  <div id="timer">Solve the maze to proceed: 0 seconds elapsed</div>

  <script>
    const mazeCanvas = document.getElementById("mazeCanvas");
    const ctx = mazeCanvas.getContext("2d");
    const mazeSize = 15;
    const cellSize = mazeCanvas.width / mazeSize;
    let maze, player, end;
    let elapsedTime = 0;
    let timerInterval;
    let mazeInterval;
    let mazeSolved = false;

    function generateMaze(size) {
      const maze = Array(size).fill(null).map(() => Array(size).fill(1));
      const stack = [];
      let x = 0,
        y = 0;
      maze[y][x] = 0;
      stack.push([x, y]);

      while (stack.length > 0) {
        const [cx, cy] = stack[stack.length - 1];
        const directions = [];
        if (cx > 1 && maze[cy][cx - 2] === 1) directions.push([-2, 0]);
        if (cx < size - 2 && maze[cy][cx + 2] === 1) directions.push([2, 0]);
        if (cy > 1 && maze[cy - 2][cx] === 1) directions.push([0, -2]);
        if (cy < size - 2 && maze[cy + 2][cx] === 1) directions.push([0, 2]);

        if (directions.length > 0) {
          const [dx, dy] = directions[Math.floor(Math.random() * directions.length)];
          maze[cy + dy / 2][cx + dx / 2] = 0;
          maze[cy + dy][cx + dx] = 0;
          stack.push([cx + dx, cy + dy]);
        } else {
          stack.pop();
        }
      }
      return maze;
    }

    function drawMaze() {
      ctx.clearRect(0, 0, mazeCanvas.width, mazeCanvas.height);
      for (let i = 0; i < mazeSize; i++) {
        for (let j = 0; j < mazeSize; j++) {
          if (maze[i][j] === 1) {
            ctx.fillStyle = "#000";
            ctx.fillRect(j * cellSize, i * cellSize, cellSize, cellSize);
          }
        }
      }
      ctx.fillStyle = "#f7931a";
      ctx.fillRect(player.x * cellSize, player.y * cellSize, cellSize, cellSize);
      ctx.fillStyle = "#33cc33";
      ctx.fillRect(end.x * cellSize, end.y * cellSize, cellSize, cellSize);
    }

    function initializeMaze() {
      maze = generateMaze(mazeSize);
      player = { x: 0, y: 0 };
      end = { x: mazeSize - 1, y: mazeSize - 1 };
      mazeSolved = false;
      drawMaze();
      startTimer();
      startMazeInterval();
    }

    function startTimer() {
      elapsedTime = 0;
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        elapsedTime++;
        document.getElementById("timer").innerText = `Solve the maze to proceed: ${elapsedTime} seconds elapsed`;
      }, 1000);
    }

    function startMazeInterval() {
      clearInterval(mazeInterval);
      mazeInterval = setInterval(() => {
        if (!mazeSolved) {
          initializeMaze();
        }
      }, 45000);
    }

    function grantAccess() {
      clearInterval(timerInterval);
      clearInterval(mazeInterval);
      document.getElementById("timer").innerText = "Access Granted! You solved the maze.";
    }

    document.addEventListener("keydown", (e) => {
      if (mazeSolved) return;
      const moves = {
        ArrowUp: { x: 0, y: -1 },
        ArrowDown: { x: 0, y: 1 },
        ArrowLeft: { x: -1, y: 0 },
        ArrowRight: { x: 1, y: 0 },
      };
      const move = moves[e.key];
      if (move) {
        const newX = player.x + move.x;
        const newY = player.y + move.y;
        if (
          newX >= 0 &&
          newX < mazeSize &&
          newY >= 0 &&
          newY < mazeSize &&
          maze[newY][newX] === 0
        ) {
          player.x = newX;
          player.y = newY;
          drawMaze();
          if (player.x === end.x && player.y === end.y) {
            mazeSolved = true;
            grantAccess();
          }
        }
      }
    });

    // HTML structure for on-screen buttons
    const buttonContainer = document.createElement("div");
    buttonContainer.style.position = "fixed";
    buttonContainer.style.bottom = "20px";
    buttonContainer.style.left = "50%";
    buttonContainer.style.transform = "translateX(-50%)";
    buttonContainer.style.display = "flex";
    buttonContainer.style.flexDirection = "column";
    buttonContainer.style.alignItems = "center";

    document.body.appendChild(buttonContainer);

    const upButton = document.createElement("button");
    upButton.innerText = "↑";
    upButton.style.width = "50px";
    upButton.style.height = "50px";
    upButton.style.margin = "5px";
    upButton.style.fontSize = "20px";

    const middleRow = document.createElement("div");
    middleRow.style.display = "flex";

    const leftButton = document.createElement("button");
    leftButton.innerText = "←";
    leftButton.style.width = "50px";
    leftButton.style.height = "50px";
    leftButton.style.margin = "5px";
    leftButton.style.fontSize = "20px";

    const downButton = document.createElement("button");
    downButton.innerText = "↓";
    downButton.style.width = "50px";
    downButton.style.height = "50px";
    downButton.style.margin = "5px";
    downButton.style.fontSize = "20px";

    const rightButton = document.createElement("button");
    rightButton.innerText = "→";
    rightButton.style.width = "50px";
    rightButton.style.height = "50px";
    rightButton.style.margin = "5px";
    rightButton.style.fontSize = "20px";

    buttonContainer.appendChild(upButton);
    buttonContainer.appendChild(middleRow);
    middleRow.appendChild(leftButton);
    middleRow.appendChild(downButton);
    middleRow.appendChild(rightButton);

    // Event listeners for on-screen buttons
    upButton.addEventListener("click", () => simulateKeyPress("ArrowUp"));
    leftButton.addEventListener("click", () => simulateKeyPress("ArrowLeft"));
    downButton.addEventListener("click", () => simulateKeyPress("ArrowDown"));
    rightButton.addEventListener("click", () => simulateKeyPress("ArrowRight"));

    // Function to simulate key press events
    function simulateKeyPress(key) {
      const event = new KeyboardEvent("keydown", { key });
      document.dispatchEvent(event);
    }

    initializeMaze();
  </script>
</body>
</html>
